(ks["tripTaroGlobal43"]=ks["tripTaroGlobal43"]||[]).push([[173],{4232:function(t,e,n){var o=n(3552)["default"],i=n(3619)["default"],a=n(6371)["default"];t.exports=function(t){var e={};function n(o){if(e[o])return e[o].exports;var i=e[o]={i:o,l:!1,exports:{}};return t[o].call(i.exports,i,i.exports,n),i.l=!0,i.exports}return n.m=t,n.c=e,n.d=function(t,e,o){n.o(t,e)||Object.defineProperty(t,e,{enumerable:!0,get:o})},n.r=function(t){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})},n.t=function(t,e){if(1&e&&(t=n(t)),8&e)return t;if(4&e&&"object"==a(t)&&t&&t.__esModule)return t;var o=Object.create(null);if(n.r(o),Object.defineProperty(o,"default",{enumerable:!0,value:t}),2&e&&"string"!=typeof t)for(var i in t)n.d(o,i,function(e){return t[e]}.bind(null,i));return o},n.n=function(t){var e=t&&t.__esModule?function(){return t.default}:function(){return t};return n.d(e,"a",e),e},n.o=function(t,e){return Object.prototype.hasOwnProperty.call(t,e)},n.p="",n(n.s=4)}([function(t,e,o){"use strict";var a;o.d(e,"a",(function(){return p})),o.d(e,"d",(function(){return m})),o.d(e,"m",(function(){return L})),o.d(e,"f",(function(){return O})),o.d(e,"g",(function(){return g})),o.d(e,"j",(function(){return u})),o.d(e,"k",(function(){return I})),o.d(e,"i",(function(){return h})),o.d(e,"n",(function(){return y})),o.d(e,"h",(function(){return T})),o.d(e,"e",(function(){return _})),o.d(e,"b",(function(){return x})),o.d(e,"c",(function(){return C})),o.d(e,"l",(function(){return v}));var r=o(2),s=o(1),u=r.version,c=void 0!==c?c:n.g&&n.g.cwx&&n.g.cwx.cwx,d=void 0!==d?d:n.g&&n.g.cwx&&n.g.cwx.__global,l={id:2,name:"detail_claimcoupon"},p=(a={},i(a,s.e.TICKET,"tkt"),i(a,s.e.THINGS_TODO,"act"),i(a,s.e.TOUR,"grp"),i(a,s.e.CRUISE,"cru"),a);function m(t){var e;return e={pageId:t.pageId,componentId:l.id,componentName:l.name,componentVersion:u,ubtSourceKey:p[t.source]},e}function f(t,e){var n=Math.abs(t),o=e-(n+"").length;return(t<0?"-":"")+"0".repeat(o<0?0:o)+n}function g(){var t=(new Date).getTimezoneOffset(),e=Math.abs(t/60),n=Math.abs(t%60);return{desc:"GMT".concat(t>0?"-":"+").concat(f(Math.floor(e),2),":").concat(f(n,2)),offset:t}}function b(t){var e;return t||(e=n.g&&n.g.cwx&&n.g.cwx.cwx),t&&(e=t),e}function v(t){return t||(t=n.g&&n.g.cwx&&n.g.cwx.__global),t}function h(t,e){var n=b(),o=null;if(n&&(o=n&&n.sendUbtByPage&&n.sendUbtByPage.ubtTrace),o)try{o(t,e)}catch(t){}}function I(){return b(),wx.request}function y(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},e=arguments.length>1?arguments[1]:void 0,n=b();n&&n.user.login({param:t,callback:e})}function S(t){switch(t.promotionStatus){case 1:t.disableButton=!1,t.buttonText="\u7acb\u5373\u9886\u53d6";break;case 2:case 3:t.disableButton=!0,t.buttonText="\u5df2\u9886\u53d6",t.showImg=!0;break;case 4:t.disableButton=!0,t.buttonText="\u5df2\u62a2\u5149";break;case 5:t.disableButton=!0,t.buttonText="\u5df2\u8fc7\u671f";break;case 6:t.disableButton=!0,t.buttonText="\u672a\u5f00\u59cb";break;case 7:t.disableButton=!0,t.buttonText="\u65b0\u5ba2\u4e13\u4eab";break;default:t.disableButton=!0,t.buttonText=""}return t}function T(t){var e=[[],[]];return e[0]=t.claimList.map((function(t){return S(t)})),e[1]=t.useableList.map((function(t){return t.status?t.promotionStatus=2:t.promotionStatus=3,S(t)})),e}var _=function(t){var e={availableClaimList:[],availableUseList:[],receivedNouseList:[],robbedList:[],expiredList:[],notStartedList:[],singkekList:[]};function n(t){return{promotionId:t.promotionId,couponCode:t.couponCode,couponName:t.couponName,deductionStrategyType:t.deductionStrategyType,deductionList:t.deductionList,deductionAmount:t.deductionAmount,matchedQuantity:t.matchedQuantity}}function o(t){switch(t.promotionStatus){case 1:e.availableClaimList.push(n(t));break;case 2:e.availableUseList.push(n(t));break;case 3:e.receivedNouseList.push(n(t));break;case 4:e.robbedList.push(n(t));break;case 5:e.expiredList.push(n(t));break;case 6:e.notStartedList.push(n(t));break;case 7:e.singkekList.push(n(t))}}return t.claimList.forEach((function(t){o(t)})),t.useableList.forEach((function(t){t.status?t.promotionStatus=2:t.promotionStatus=3,o(t)})),e};function C(t){var e=t.ctrlName,n=t.productId,o=t.scenicSpotId,i=t.promotionId,a=t.positionId,r=t.pageId,s=m(t),c="".concat(s.ubtSourceKey,"-").concat(r,"-coupon-").concat(e,"-").concat(s.componentName,"-").concat(u);return i>0?"".concat(c,"-").concat(n||o,"-").concat(i,"-").concat(a):c}var x=function(t){return 2!=t.promotionStatus&&3!=t.promotionStatus||(t.showImg=!0),t};function L(t,e,n,o){var i,a=e-t;return a<=0?(n(),null):(a>3e3?(a-=3e3,i=o):i=n,setTimeout((function(){i()}),a))}function O(t){var e=new Date(t);return 1e3*(60*(60*(24-e.getHours())-e.getMinutes())-e.getSeconds())-e.getMilliseconds()}},function(t,e,n){"use strict";var o,i,a,r,s,u,c,d,l;n.d(e,"c",(function(){return o})),n.d(e,"e",(function(){return r})),n.d(e,"d",(function(){return s})),n.d(e,"a",(function(){return c})),n.d(e,"b",(function(){return d})),function(t){t.Fat="fat",t.Uat="uat",t.Prod="prd"}(o||(o={})),function(t){t[t.Ctrip_Online=2]="Ctrip_Online",t[t.Ctrip_App=5]="Ctrip_App",t[t.Ctrip_H5=7]="Ctrip_H5",t[t.Ctrip_Mina=21]="Ctrip_Mina",t[t.Trip_Online=24]="Trip_Online",t[t.Trip_App=25]="Trip_App",t[t.Trip_H5=26]="Trip_H5",t[t.Offline=3]="Offline",t[t.CompanyShop=110]="CompanyShop",t[t.BestonShop=111]="BestonShop",t[t.QunarShop=112]="QunarShop",t[t.LvJing=113]="LvJing"}(i||(i={})),function(t){t[t.Ctrip_Online=114]="Ctrip_Online",t[t.Ctrip_App=115]="Ctrip_App",t[t.Ctrip_H5=116]="Ctrip_H5",t[t.Ctrip_Mina=117]="Ctrip_Mina",t[t.Trip_Online=118]="Trip_Online",t[t.Trip_App=119]="Trip_App",t[t.Trip_H5=120]="Trip_H5",t[t.Offline=121]="Offline",t[t.CompanyShop=502]="CompanyShop",t[t.BestonShop=503]="BestonShop",t[t.QunarShop=504]="QunarShop",t[t.LvJing=505]="LvJing"}(a||(a={})),function(t){t.TICKET="TICKET",t.THINGS_TODO="THINGS_TODO",t.TOUR="TOUR",t.CRUISE="CRUISE"}(r||(r={})),function(t){t.PRODUCTID="PRODUCTID",t.VENDORID="VENDORID",t.SCENICSPOTID="SCENICSPOTID",t.POIID="POIID"}(s||(s={})),function(t){t[t.Company=1]="Company",t[t.Vendor=2]="Vendor"}(u||(u={})),function(t){t[t.H5=1]="H5",t[t.PC=2]="PC",t[t.RN=3]="RN",t[t.MiniProgram=4]="MiniProgram",t[t.Taro=5]="Taro"}(c||(c={})),function(t){t[t.OrderUse=1]="OrderUse",t[t.DetailClaim=2]="DetailClaim",t[t.PopClaim=3]="PopClaim",t[t.ShopClaim=4]="ShopClaim"}(d||(d={})),function(t){t.AVAILABlE_CLAIM_LIST="availableClaimList",t.AVAILABLE_USE_LIST="availableUseList",t.RECEIVED_NOUSE_LIST="receivedNouseList",t.ROBBED_LIST="robbedList",t.EXPIRED_LIST="expiredList",t.NOT_STARTED="notStartedList",t.SINGKEK_LIST="singkekList"}(l||(l={}))},function(t){t.exports=JSON.parse('{"name":"@ctrip/ttd-marketing-wechat","version":"1.0.25","description":"","main":"miniprogram_dist/index.js","scripts":{"dev":"cross-env NODE_ENV=development gulp dev --develop","watch":"cross-env NODE_ENV=development gulp watch --develop --watch","build":"cross-env NODE_ENV=production gulp","dist":"npm run build","clean-dev":"gulp clean --develop","clean":"gulp clean","test":"jest --bail","test-debug":"node --inspect-brk ./node_modules/jest/bin/jest.js --runInBand --bail","coverage":"jest ./test/* --coverage --bail","lint":"eslint \\"src/**/*.js\\" --fix","lint-tools":"eslint \\"tools/**/*.js\\" --rule \\"import/no-extraneous-dependencies: false\\" --fix","baidu":"npm run build && cd miniprogram_dist && antmove wx-baidu"},"miniprogram":"miniprogram_dist","jest":{"testEnvironment":"jsdom","testURL":"https://jest.test","collectCoverageFrom":["miniprogram_dist/**/*.js"],"moduleDirectories":["node_modules","miniprogram_dist"]},"files":["miniprogram_dist"],"repository":{"type":"git","url":"http://git.ctripcorp.com/ttd/ttd-front-marketing-components/tree/wechatCoupon"},"author":"zhijie.su","license":"MIT","devDependencies":{"@typescript-eslint/eslint-plugin":"^2.28.0","@typescript-eslint/parser":"^2.28.0","antmove":"^1.1.12","babel-core":"^6.26.3","babel-loader":"^7.1.5","babel-plugin-module-resolver":"^3.2.0","babel-preset-env":"^1.7.0","colors":"^1.3.1","cross-env":"^7.0.3","eslint":"^5.14.1","eslint-config-airbnb-base":"13.1.0","eslint-loader":"^2.1.2","eslint-plugin-import":"^2.16.0","eslint-plugin-node":"^7.0.1","eslint-plugin-promise":"^3.8.0","gulp":"^4.0.0","gulp-clean":"^0.4.0","gulp-if":"^2.0.2","gulp-install":"^1.1.0","gulp-less":"^4.0.1","gulp-rename":"^1.4.0","gulp-sourcemaps":"^2.6.5","jest":"^23.5.0","miniprogram-api-typings":"^2.10.3-1","miniprogram-simulate":"^1.2.5","thread-loader":"^2.1.3","through2":"^2.0.3","ts-loader":"^7.0.0","typescript":"^3.8.3","vinyl":"^2.2.0","webpack":"^4.29.5","webpack-node-externals":"^1.7.2"},"dependencies":{}}')},,function(t,e,n){"use strict";n.r(e);var i=n(0),a="\nfragment claimCouponInfoFields on ClaimCouponInfoType{\n    promotionId\n    couponName\n    couponCode\n    couponType\n    promotionSecretId\n    leftCount\n    promotionStatus\n    status\n    shortRemark\n    jumpUrl\n    productLineIcon\n    detailRemarkShown\n    startDateShown\n    endDateShown\n    useDateShown\n    deductionInfoShown {\n        type\n        fullDeduction\n        desc\n        amount\n        discountUnit\n        deductionList\n        deductionAmount\n    }\n    deductionAmount\n    deductionStrategyType\n    deductionList{\n        id\n        deductionType\n        startAmount\n        deductionAmount\n        deductionAmountLimit\n        hit\n    }\n    unavailableReasonShown\n    unavailableReasonList{\n        code\n        message\n    }\n    extendInfo{\n        userFilter\n    }\n    promotionLabel\n    activityStatus\n    nextAvailableTime\n    activityStatus\n    disableButton\n    buttonText\n}\n",r="\n".concat(a,"\n\nfragment couponInfoFields on CouponInfoType{\n    promotionId\n    couponName\n    couponCode\n    couponType\n    status\n    shortRemark\n    detailRemarkShown\n    startDateShown\n    endDateShown\n    useDateShown\n    deductionInfoShown {\n        type\n        fullDeduction\n        desc\n        amount\n        discountUnit\n        deductionList\n    }\n    deductionAmount\n    matchedQuantity\n    deductionStrategyType\n    deductionList{\n        id\n        deductionType\n        startAmount\n        deductionAmount\n        deductionAmountLimit\n        hit\n    }\n    unavailableReasonShown\n    isTopOne\n    extendInfo{\n        userFilter\n    }\n}\n\nquery($baseInfo:BaseInfoType,$productId:Int,$scenicSpotId:Int,$queryShark:Boolean=false,$sharkLocale:String,$needUseableList:Boolean){\n    claimCouponList:getClaimCouponList(baseInfo:$baseInfo,productId:$productId,scenicSpotId:$scenicSpotId,needUseableList:$needUseableList){\n        __typename\n       ...on GetClaimCouponData{\n           claimList{\n                ...claimCouponInfoFields,\n           }\n           useableList{\n                ...couponInfoFields,\n           }\n       }\n       ...on Error{\n           message\n           code\n       }\n    }\n    sharkData:getShark(local:$sharkLocale) @include(if: $queryShark) {\n        __typename\n       ...on SharkData{\n           data\n       }\n       ...on Error{\n           message\n           code\n       }\n    }\n }\n "),s="  \n".concat(a,"\n\nquery($baseInfo:BaseInfoType,$relationDetail:RelationDetailType,$receivePromotionType:Int,$shownewuserpromo:Boolean,\n    $filterType:Int,$utcOffset:Int,$getServerTime:Boolean=false){\n    receivePromotionData: getReceivePromotionByRelationId(baseInfo:$baseInfo,relationDetail:$relationDetail,\n    receivePromotionType:$receivePromotionType,shownewuserpromo:$shownewuserpromo,filterType:$filterType){\n        __typename\n       ...on GetReceivePromotionByRelationIdData{\n           list{\n                ...claimCouponInfoFields,\n           }\n       }\n       ...on Error{\n           message\n           code\n       }\n    }\n    serverTime:getServerTime(utcOffset:$utcOffset) @include(if: $getServerTime) {\n        __typename\n        ...on GetServerTimeData{\n            serverTime\n        }\n    }\n }  \n"),u=n(1),c={fat:"https://gateway.m.fws.qa.nt.ctripcorp.com/restapi",uat:"https://gateway.m.uat.qa.nt.ctripcorp.com/restapi",prd:"https://m.ctrip.com/restapi"};function d(t){return{allianceId:t.allianceId,channelId:t.saleChannel,clientId:t.clientId,currency:t.currency,locale:t.locale,siteId:t.siteId,source:t.source,uid:t.uid||"",utcOffset:i.g().offset,rmsToken:t.rmsToken,requestScene:u.b.DetailClaim,version:i.j,componentType:u.a.MiniProgram}}function l(t,e){var n=c[t],o="";return t==u.c.Fat&&(o="fat6"),n+function(t){return t?"/ttd/marketing-bff-"+t:"/ttd/marketing-bff"}(o)+"/graphql/"+e}function p(){var t,e,n=!(arguments.length>0&&void 0!==arguments[0])||arguments[0],o=arguments.length>1?arguments[1]:void 0,a=arguments.length>2?arguments[2]:void 0,r=arguments.length>3?arguments[3]:void 0,c=arguments.length>4?arguments[4]:void 0;if(o.productId>0)t=o.productId,e=u.d.PRODUCTID;else if(o.scenicSpotId>0)t=o.scenicSpotId,e=u.d.SCENICSPOTID;else{if(!(o.poiId>0))throw new Error("\u53c2\u6570\u9519\u8bef\uff0cproductId\u3001scenicSpotId\u3001poiId\u81f3\u5c11\u4f20\u5165\u4e00\u4e2a");t=o.poiId,e=u.d.POIID}var p={query:s,queryName:"getReceivePromotionByRelationId",head:{ctType:0,auth:wx.getStorageSync("auth")?wx.getStorageSync("auth"):""},variables:{relationDetail:{relationType:e,relationId:t},receivePromotionType:o.receivePromotionType,shownewuserpromo:!0,filterType:n?o.needUseableList?1:2:0,utcOffset:i.g().offset,getServerTime:!0,baseInfo:d(o)}};console.log("ttd-marketing-getReceivePromotionByRelationId requestOption:",p);var f=l(a,"getReceivePromotionByRelationId");return m(f,p,(function(t){console.log("ttd-marketing-getReceivePromotionByRelationId responseData:",t),r&&r(t.data&&t.data.data),i.i("ttd_marketing_bffextensions",{queryName:"getReceivePromotionByRelationId",extensions:{url:f,requestBody:Object.assign({},o),responseBody:Object.assign({},t)}})}),(function(){c&&c()}))}function m(t,e,n,o){return i.k()({url:t,data:Object.assign({},e),header:{"content-type":"application/json"},method:"POST",dataType:"json",responseType:"text",success:function(t){n&&n(t)},fail:function(){o&&o(),i.i("ttd_marketing_jserror",{queryName:"claimCoupon",extensions:{url:t,requestBody:Object.assign({},e)}})},complete:function(){}})}var f=!1;Component({options:{multipleSlots:!0,addGlobalClass:!0,pureDataPattern:/^coupon_/},properties:{title:{type:String,value:"\u4f18\u60e0\u5238"},extClass:{type:String,value:""},visible:{type:Boolean,value:!1,observer:"_showChange"},maskClosable:{type:Boolean,value:!0},businessParams:{type:Object,value:{}},isShowEmptyContent:{type:Boolean,value:!0}},data:{timeZone:i.g(),interfaceList:[],claimList:[],usebleList:[],openCode:0,toView:"green",__businessParams:{allianceId:0,clientId:"",currency:"CNY",locale:"zh-CN",needUseableList:!0,pageId:"",env:i.l()&&i.l().env?i.l().env:"fat"},coupon_flagd:!1},lifetimes:{attached:function(){var t=this;console.log("current ttd-marketing-cliamCoupon-package version is:",i.j),this._timerMap={};var e=Object.assign({},this.data.__businessParams,this.data.businessParams),n=Object.keys(this.data.businessParams);n&&0!==n.length&&this.setData({businessParams:e},(function(){t.initPageList((function(e){var n=e.serverTime,o=e.claimList;e.usebleList;t.setActivityTimeTask(o,n),t.setZeroRefeshTask(n,o)}))}))},detached:function(){if(this._timerMap){var t=Object.keys(this._timerMap);t.forEach((function(e){clearTimeout(t[e])}))}}},observers:{visible:function(t){var e=i.d(this.data.businessParams),n=e.ubtSourceKey+"_"+e.componentName+"_exposure";t?i.i(n,{comptID:e.componentId,ttdver:i.j,productId:this.data.businessParams.productId?this.data.businessParams.productId:void 0,scenicSpotId:this.data.businessParams.scenicSpotId?this.data.businessParams.scenicSpotId:void 0}):this._commonLogTrace("ttd_marketing_claimcoupon_close")}},methods:{setActivityTimeTask:function(t,e){var n=this;t&&0!=t.length&&t.forEach((function(o){if(1==o.promotionStatus&&1==o.activityStatus){var a=n._timerMap[o.promotionId];a&&clearTimeout(a);var r=i.m(e,o.nextAvailableTime,(function(){n._changeCouponStatus(o.promotionId,!1,"\u4e00\u952e\u9886\u53d6",{showImg:!1,activityStatus:2})}),(function(){n.refreshCoupon([o.promotionId],t)}));r&&(n._timerMap[o.promotionId]=r)}}))},setZeroRefeshTask:function(t,e){var n=this,o=i.f(t),a=e.filter((function(t){return 1==t.promotionStatus&&1==t.activityStatus})).map((function(t){return t.promotionId})),r=setTimeout((function(){n.refreshCoupon(a,e)}),o);this._timerMap.ZERO_TASK=r},refreshCoupon:function(t,e){var n=this;if(t&&0!=t.length){var i=o(e);p(!0,Object.assign({},this.data.__businessParams,this.data.businessParams),this.data.__businessParams.env,(function(e){var o=e&&e.receivePromotionData&&e.receivePromotionData.list||[],a=e&&e.serverTime&&e.serverTime.serverTime?parseInt(e.serverTime.serverTime):null;t.forEach((function(t){var e=o.find((function(e){return e.promotionId==t})),r=i.find((function(e){return e.promotionId==t}));if(e&&r)if(Object.assign(r,{disableButton:e.disableButton,buttonText:e.buttonText,activityStatus:e.activityStatus,promotionStatus:e.promotionStatus}),1==e.promotionStatus&&1==e.activityStatus)n.setActivityTimeTask([e],a);else{var s=n._timerMap[e.promotionId];s&&clearTimeout(s)}})),i.forEach((function(e){var i=o.find((function(t){return t.promotionId==e.promotionId}));if(t.includes(e.promotionId)&&i)if(Object.assign(e,{disableButton:i.disableButton,buttonText:i.buttonText,activityStatus:i.activityStatus,promotionStatus:i.promotionStatus}),1==i.promotionStatus&&1==i.activityStatus)n.setActivityTimeTask([i],a);else{var r=n._timerMap[i.promotionId];r&&clearTimeout(r)}})),n.setData({claimList:i})}))}},initPageList:function(t){var e=this,n=null,o=Object.assign({},this.data.__businessParams,this.data.businessParams),a=new Promise((function(t,a){p(!0,o,e.data.__businessParams.env,(function(e){var o=e&&e.receivePromotionData&&e.receivePromotionData.list||[];n=e&&e.serverTime&&e.serverTime.serverTime?parseInt(e.serverTime.serverTime):null,o.forEach((function(t){i.b(t)})),t(o)}),(function(){a(null)}))})),r=new Promise((function(t,n){!function(){var t=!(arguments.length>0&&void 0!==arguments[0])||arguments[0],e=arguments.length>1?arguments[1]:void 0,n=arguments.length>2?arguments[2]:void 0,o=arguments.length>3?arguments[3]:void 0,a=arguments.length>4?arguments[4]:void 0;if(!e.needUseableList)return o&&o(null);if(!e.productId)throw new Error("productId can't be null if needUseableList !");var r={query:"\n    \n    fragment couponInfoFields on CouponInfoType{\n        promotionId\n        couponName\n        couponCode\n        couponType\n        status\n        shortRemark\n        detailRemarkShown\n        startDateShown\n        endDateShown\n        useDateShown\n        deductionInfoShown {\n            type\n            fullDeduction\n            desc\n            amount\n            discountUnit\n            deductionList\n            deductionAmount\n        }\n        deductionAmount\n        matchedQuantity\n        deductionStrategyType\n        deductionList{\n            id\n            deductionType\n            startAmount\n            deductionAmount\n            deductionAmountLimit\n            hit\n        }\n        unavailableReasonShown\n        isTopOne\n        extendInfo{\n            userFilter\n            scheduleFrom\n            scheduleTo\n        }\n        unavailableReasonList{\n            code\n            message\n        }\n        promotionLabel\n        promotionStatus\n        disableButton\n        buttonText\n}\n\n    query($baseInfo:BaseInfoType,$productIDList:[Int],$filterType:Int){\n        promotionTagData: getPromotionTag(baseInfo:$baseInfo,productIDList:$productIDList, filterType:$filterType){\n            __typename\n           ...on GetPromotionTagData{\n               list{\n                    ...couponInfoFields,\n               }\n           }\n           ...on Error{\n               message\n               code\n           }\n        }\n     }  \n\n",queryName:"getPromotionTag",head:{ctType:0,auth:wx.getStorageSync("auth")?wx.getStorageSync("auth"):""},variables:{productIDList:[e.productId],filterType:t?1:0,baseInfo:d(e)}};console.log("ttd-marketing-getPromotionTag requestOption:",r);var s=l(n,"getPromotionTag");m(s,r,(function(t){console.log("ttd-marketing-getPromotionTag responseData:",t),o&&o(t.data&&t.data.data),i.i("ttd_marketing_bffextensions",{queryName:"getPromotionTag",extensions:{url:s,requestBody:Object.assign({},e),responseBody:Object.assign({},t)}})}),(function(){a&&a()}))}(!0,o,e.data.__businessParams.env,(function(e){var n=e&&e.promotionTagData&&e.promotionTagData.list||[];n.forEach((function(t){i.b(t)})),t(n)}),(function(){n(null)}))}));Promise.all([a,r]).then((function(o){var a={claimList:o[0]||[],useableList:o[1]||[]},r=i.e(a),s=Object.assign({list:a},r);e.setData({claimList:o[0]||[],usebleList:o[1]||[]},(function(){t&&t(Object.assign(Object.assign({},a),{serverTime:n}))})),e.triggerEvent("load-data",s),e._commonLogTrace("ttd_marketing_claimcoupon_load")}))},getCouponById:function(t,e){!function(t,e,n,o){var a={query:r,queryName:"claimCouponList",head:{auth:wx.getStorageSync("auth")?wx.getStorageSync("auth"):""},variables:{needUseableList:t.needUseableList,productId:t.productId,scenicSpotId:t.scenicSpotId,baseInfo:d(t)}};console.log("ttd-marketing-claimCouponList requestOption:",a);var s=l(e,"claimCouponList");m(s,a,(function(e){console.log("ttd-marketing-claimCouponList responseData:",e),n&&n(e),i.i("ttd_marketing_bffextensions",{queryName:"claimCouponList",extensions:{url:s,requestBody:Object.assign({},t),responseBody:Object.assign({},e)}})}),(function(){o&&o()}))}(Object.assign({},this.data.__businessParams,this.data.businessParams),this.data.__businessParams.env,(function(n){if(n.data.data&&n.data.data.claimCouponList){var o=n.data.data.claimCouponList,a=i.h(o),r=null;r=a[0].find((function(e){return e.promotionId===t&&1!=e.promotionStatus})),r||(r=a[1].find((function(e){return e.promotionId===t&&1!=e.promotionStatus}))),e&&e(r)}else e&&e("")}))},close:function(t){var e=this,n=t.currentTarget.dataset.type;(this.data.maskClosable||"close"===n)&&(this.setData({visible:!1},(function(){var t=e.data.coupon_flagd;t&&e.initPageList((function(){e.setData({coupon_flagd:!1})}))})),this.triggerEvent("close"))},opendetail:function(t){var e=t.detail.promotionId;this.setData({openCode:e})},claimCoupon:function(t){var e=this,n=t.detail,o=n.promotionSecretId,a=n.promotionId,r=Object.assign(Object.assign({},Object.assign({},this.data.__businessParams,this.data.businessParams)),{promotionSecretIds:[o]});f||(f=!0,function(t,e,n,o){var a={query:"\nquery($baseInfo:BaseInfoType,$promotionSecretIds:[String]){\n    claimCoupon(baseInfo:$baseInfo,promotionSecretIds:$promotionSecretIds){\n        __typename\n        ...on ClaimCouponData{\n            claimResultList{\n                promotionId\n                couponCode\n                promotionSecretId\n                buttonText\n                disableButton\n                success\n                showToast\n                toastType\n                code\n                message\n                serviceMessage\n            }\n        }\n        ...on Error{\n            message\n            code\n        }\n    }\n    \n    }  \n",queryName:"claimCoupon",head:{auth:wx.getStorageSync("auth")?wx.getStorageSync("auth"):""},variables:{promotionSecretIds:t.promotionSecretIds,baseInfo:d(t)}};console.log("claimCoupon requestOption:",a);var r=l(e,"claimCoupon");m(r,a,(function(e){console.log("claimCoupon responseData:",e),n&&n(e),i.i("ttd_marketing_bffextensions",{queryName:"claimCoupon",extensions:{url:r,requestBody:Object.assign({},t),responseBody:Object.assign({},e)}})}),(function(){o&&o()}))}(r,this.data.__businessParams.env,(function(t){f=!1;var n=t.data&&t.data.data?t.data.data.claimCoupon:{};if(200==t.statusCode)if("Error"==n.__typename)n&&4001==n.code&&i.n({},(function(t){if(t&&"0"===t.ReturnCode)return console.log("\u767b\u5f55\u6210\u529f\uff01\uff01"),void e.initPageList((function(){var t=e.data.claimList.filter((function(t){return t.promotionSecretId==o}));t.length>0&&1==t[0].promotionStatus&&e.claimCoupon({detail:{promotionSecretId:o,promotionId:a}})}))}));else{var r=n.claimResultList[0],s={};s.buttonText=r.buttonText,s.disableButton=r.disableButton,s.showImg=r.success,s.claimAnimation=r.success,e.getCouponById(a,(function(t){s.useDateShown=t.useDateShown,s.promotionStatus=t.promotionStatus,s.activityStatus=t.activityStatus,e.setData({coupon_flagd:!0},(function(){e._changeCouponStatus(a,!0,"",s),r.showToast&&r.message&&wx.showToast({title:r.message,icon:"none"})}))}))}else wx.showToast({title:"\u9886\u53d6\u5931\u8d25",icon:"none"})}),(function(){f=!1,wx.showToast({title:"\u9886\u53d6\u5931\u8d25",icon:"none"})})))},_changeCouponStatus:function(t,e,n,o){var i=this.data.claimList.slice();i.forEach((function(i){i.promotionId==t&&(i.disableButton=e,i.buttonText=n,o&&Object.assign(i,o))})),this.setData({claimList:i})},_commonLogTrace:function(t,e){var n=e||{props:Object.assign({},this.data)};i.i(t,n)},onConentMousemove:function(t){},onMaskMouseMove:function(t){}}})}])},2781:function(t,e,n){"use strict";var o=n(2180),i=n(4232),a=n.n(i);Component((0,o.createComponentConfig)(a(),"pages/taroDemo/components/claimCoupon/claimCoupon"))},6061:function(t){function e(t,e){(null==e||e>t.length)&&(e=t.length);for(var n=0,o=new Array(e);n<e;n++)o[n]=t[n];return o}t.exports=e,t.exports.__esModule=!0,t.exports["default"]=t.exports},926:function(t,e,n){var o=n(6061);function i(t){if(Array.isArray(t))return o(t)}t.exports=i,t.exports.__esModule=!0,t.exports["default"]=t.exports},3619:function(t,e,n){var o=n(2435);function i(t,e,n){return e=o(e),e in t?Object.defineProperty(t,e,{value:n,enumerable:!0,configurable:!0,writable:!0}):t[e]=n,t}t.exports=i,t.exports.__esModule=!0,t.exports["default"]=t.exports},8439:function(t){function e(t){if("undefined"!==typeof Symbol&&null!=t[Symbol.iterator]||null!=t["@@iterator"])return Array.from(t)}t.exports=e,t.exports.__esModule=!0,t.exports["default"]=t.exports},7138:function(t){function e(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}t.exports=e,t.exports.__esModule=!0,t.exports["default"]=t.exports},3552:function(t,e,n){var o=n(926),i=n(8439),a=n(1111),r=n(7138);function s(t){return o(t)||i(t)||a(t)||r()}t.exports=s,t.exports.__esModule=!0,t.exports["default"]=t.exports},9028:function(t,e,n){var o=n(6371)["default"];function i(t,e){if("object"!==o(t)||null===t)return t;var n=t[Symbol.toPrimitive];if(void 0!==n){var i=n.call(t,e||"default");if("object"!==o(i))return i;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===e?String:Number)(t)}t.exports=i,t.exports.__esModule=!0,t.exports["default"]=t.exports},2435:function(t,e,n){var o=n(6371)["default"],i=n(9028);function a(t){var e=i(t,"string");return"symbol"===o(e)?e:String(e)}t.exports=a,t.exports.__esModule=!0,t.exports["default"]=t.exports},1111:function(t,e,n){var o=n(6061);function i(t,e){if(t){if("string"===typeof t)return o(t,e);var n=Object.prototype.toString.call(t).slice(8,-1);return"Object"===n&&t.constructor&&(n=t.constructor.name),"Map"===n||"Set"===n?Array.from(t):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?o(t,e):void 0}}t.exports=i,t.exports.__esModule=!0,t.exports["default"]=t.exports}},function(t){var e=function(e){return t(t.s=e)};t.O(0,[107,216],(function(){return e(2781)}));t.O()}]);
//# sourceMappingURL=claimCoupon.js.map